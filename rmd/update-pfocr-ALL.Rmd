<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">
    <link rel="android-chrome" sizes="192x192" href="/assets/img/android-chrome-192x192.png">
    <link rel="android-chrome" sizes="512x512" href="/assets/img/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon-16x16.png">
    <link rel="manifest" href="/assets/img/site.webmanifest">
    <link rel="shortcut icon" href="/assets/img/favicon.ico">
    <link href="/assets/fontawesome.all.min.css" rel="stylesheet">
    <!-- Bootstrap -->
      <script src="https://code.jquery.com/jquery-3.5.1.js" type="text/javascript"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <!-- Custom style overrides-->
    <link rel="stylesheet" href="/assets/main.css">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KGQFS041KG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KGQFS041KG');
    </script> 
    <!-- Hotjar Tracking Code for Pathway Figure OCR -->
    <script>
    (function(h,o,t,j,a,r){
      h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
      h._hjSettings={hjid:3415747,hjsv:6};
      a=o.getElementsByTagName('head')[0];
      r=o.createElement('script');r.async=1;
      r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
      a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
    </script>
    
    <title>
      
        update pfocr ALL | Pathway Figure OCR
      
    </title>
  </head> 

  <body><header class="site-header" role="banner">
    <div class="wrapper">
      <!-- NAV BAR -->
      <nav class="navbar navbar-light">
        <a class="navbar-brand" href="/">
          <img src="/assets/img/pfocr_logo_500.png" height="45" class="d-inline-block align-top" alt="PFOCR logo"> Pathway Figure OCR
        </a>     
        <div>
        <!-- SEARCH  -->
        <div id="search-widget" style="float:left; margin:4px 20px 0px 0px;">
          <form id="searchForm" action="/search.html">
            <i class="fa fa-search" aria-hidden="true"></i>
            <input type="text" name="searchQuery" placeholder="&nbsp;e.g., ace2 aldosterone human">
          </form>          
        </div>
        <script>
          const searchForm = document.getElementById('searchForm');
          searchForm.addEventListener('submit', function(event) {
          event.preventDefault(); // Prevent the default form submission behavior
          const searchQuery = encodeURIComponent(searchForm.elements.searchQuery.value); // Get the search query and encode it
          const searchUrl = `/search.html?query=${searchQuery}`; // Construct the search results page URL with the search query as a parameter
          window.location.href = searchUrl; // Navigate to the search results page
          });
        </script>
        <!-- MENU -->         
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        </div>
        <div class="collapse navbar-collapse " id="navbarNavAltMarkup">
          <div class="nav justify-content-center">
            <a class="nav-item nav-link" href="/about.html">About</a>
            <a class="nav-item nav-link" href="/search.html">Search</a>
            <a class="nav-item nav-link" href="/#browse">Browse</a>
            <a class="nav-item nav-link" href="/#download">Download</a>
            <a class="nav-item nav-link" href="/#download">Analyze</a>
            <a class="nav-item nav-link" href="/help.html">Help</a>
          </div>
        </div>
      </nav>
    </div>
  </header>    
  
    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# PFOCR Update All Figures
This R notebooks prepares md and tsv files for ALL figures in the latest PFOCR rds files and overwrites the Jekyll web content. ***Be sure to extract any curated content and merge with latest rds files prior to this updating.***
 
```{r install, include=FALSE}
library(tidyr)
library(dplyr)
library(magrittr)
library(tools)
library(yaml)
library(stringr)
source("updatefm.R")
```

## Read PFOCR .rds files
Set the path to these files
```{r setpath, include=FALSE}
local.path <- "~/Dropbox (Gladstone)/Pathway Figure OCR/LATEST"
```

Read in files
```{r read}
figs <- readRDS(file.path(local.path,"pfocr_figures.rds"))
genes <- readRDS(file.path(local.path,"pfocr_genes.rds"))
chems <- readRDS(file.path(local.path,"pfocr_chemicals.rds"))
dis <- readRDS(file.path(local.path,"pfocr_diseases.rds"))
```

## Prefilter for gene and chem content
```{r prefilter}
keep.g <- distinct(genes, figid)
keep.c <- chems %>%
  group_by(figid, word) %>% # count unique matches
  group_by(figid) %>% 
  dplyr::summarise(cnt = n()) %>%
  dplyr::filter(cnt >= 3) %>%
  dplyr::distinct(figid) 
keep <- union(keep.g,keep.c)
# unkept <- setdiff(figs$figid, keep) # to do the small and empty ones as well

figs <- dplyr::filter(figs, figid %in% keep$figid) %>%
    dplyr::mutate(caption = str_replace_all(caption, "\r","")) %>% #\x{0D} 
    dplyr::mutate(caption = str_replace_all(caption, "\\\\","/")) %>% #\x{0D} 
    dplyr::mutate(figtitle = str_replace_all(figtitle, "\\\\","/")) #\x{0D}
genes <- dplyr::filter(genes, figid %in% keep$figid)
chems <- dplyr::filter(chems, figid %in% keep$figid) %>%
    dplyr::mutate(word = str_replace_all(word, "","")) #\037 and \x{1F}
dis <- dplyr::filter(dis, figid %in% keep$figid)%>%
    dplyr::mutate(word = str_replace_all(word, "","")) #\037 and \x{1F}
```

## Produce md and tsv
```{r md}

# Custom yaml writing function to enforce organism lists
write_yaml_custom <- function(data, con) {
  cat("---\n", file = con)
  for (i in 1:length(data)) {
      if (names(data[i]) == "organisms") {
          cat("organisms:\n", file = con, append = TRUE)
          for (o in data$organisms) {
              cat("- ",o, "\n", sep = "", file = con, append = TRUE)
          }
      } else if (names(data[i]) == "organisms_ner") {
          cat("organisms_ner:\n", file = con, append = TRUE)
          for (o in data$organisms_ner) {
              cat("- ",o, "\n", sep = "", file = con, append = TRUE)
          }
      } else {
          yaml::write_yaml(data[i], con)
      }
  }
  cat("---\n", file = con, append = TRUE)
}

i=1
batch.figs = figs[1:nrow(figs),] 
# batch.figs = filter(figs, figid %in% redo_figids6)

by(batch.figs, seq_len(nrow(batch.figs)), function(f){
  fls = as.list(f)
  fid = fls$figid
  ffp = file.path("..","_figures",paste(fid,"md",sep = "."))
  print(paste(i,ffp))
  i <<- i+1
  
  # build tables
  tbg = genes %>%
    dplyr::filter(figid == fls$figid) %>%
    dplyr::mutate(word = str_replace_all(word, '"', '')) %>%
    dplyr::mutate(word = str_replace_all(word, "'", "")) %>%
    dplyr::select(-c(figid, count_org))
  # tbgy = list(genes = unname(lapply( split(tbg,seq_along(tbg[,1])), as.list)))
  tbc = chems %>%
    dplyr::filter(figid == fls$figid) %>%
    dplyr::mutate(word = str_replace_all(word, '"', '')) %>%
    dplyr::mutate(word = str_replace_all(word, "'", "")) %>%
    dplyr::select(-c(figid))
  # tbcy = list(chemicals = unname(lapply( split(tbc,seq_along(tbc[,1])), as.list)))
  tbd = dis %>%
    dplyr::filter(figid == fls$figid) %>%
    dplyr::mutate(word = str_replace_all(word, '"', '')) %>%
    dplyr::mutate(word = str_replace_all(word, "'", "")) %>%
    dplyr::select(-c(figid))
  # tbdy = list(diseases = unname(lapply( split(tbd,seq_along(tbd[,1])), as.list)))
  
  # get ndex
  ndex = list(ndex = "")

  # get keywords
  kwg = tbg %>%
      dplyr::distinct(ncbigene_symbol)
  kwc = tbc %>%
      dplyr::distinct(word)
  kwd = tbd %>%
      dplyr::distinct(word)

  keywords = c(unlist(kwg), unlist(kwc), unlist(kwd))

  # build schema
  schema = list(seo = "CreativeWork",
                "schema-jsonld" = list("@context"="https://schema.org/",
                                   "@id"=paste0("https://pfocr.wikipathways.org/figures/",
                                                                        fid, ".html"),
                                   "@type"="Dataset",
                                   description = fls$caption,
                                   license = "CC0",
                                   name = "CreativeWork",
                                   creator = list("@type"="Organization",
                                                  name = "WikiPathways"),
                                   keywords = unname(keywords)))

  # final tweaks to content
  fls$figid = fid #stripped ext
  fls$redirect_from = paste0("/figures/",fls$figid_alias)
  clean_orgs = str_replace_all(fls$organisms, '"', '')
  clean_orgs = str_replace_all(clean_orgs, "'", "")
  clean_orgs = str_replace_all(clean_orgs, ":", "")
  fls$organisms = strsplit(clean_orgs, " \\| ")[[1]]
  clean_orgs_ner = str_replace_all(fls$organisms_ner, '"', '')
  clean_orgs_ner = str_replace_all(clean_orgs_ner, "'", "")
  clean_orgs_ner = str_replace_all(clean_orgs_ner, ":", "")
  fls$organisms_ner = strsplit(clean_orgs_ner, " \\| ")[[1]]
  if (is.na(fls$year)){fls$year = ''}

  # write to md file
  con <- file(ffp, "w")
  write_yaml_custom(append(append(fls, ndex),schema), con)
  close.connection(con)

  # write tsvs for download
  if (nrow(tbg) > 0){
    gfp = file.path("..","_data",paste0(fid,"-genes.tsv"))
    write.table(tbg, gfp, row.names = F, col.names = T, sep = "\t", quote = F)
  }
  if (nrow(tbc) > 0){
    cfp = file.path("..","_data",paste0(fid,"-chemicals.tsv"))
    write.table(tbc, cfp, row.names = F, col.names = T, sep = "\t", quote = F)
  }
  if (nrow(tbd) > 0){
    dfp = file.path("..","_data",paste0(fid,"-diseases.tsv"))
    write.table(tbd, dfp, row.names = F, col.names = T, sep = "\t", quote = F)
  }
} )

```


      </div>
    </main><footer class="site-footer h-card"> 
  <data class="u-url" href="/"></data>

  <div class="wrapper">
      <a href="https://github.com/wikipathways/pfocr-database/commits" target="_blank">
        <img alt="GitHub last commit"
          src="https://img.shields.io/github/last-commit/wikipathways/pfocr-database?label=updated">
      </a>
      <a href="https://github.com/wikipathways/pfocr-database/deployments" target="_blank">
        <img alt="GitHub deployment state" 
        src="https://img.shields.io/github/deployments/wikipathways/pfocr-database/github-pages">
      </a>
      <p style="margin-bottom: 5px;" />

    <div class="row"> 

      <div class="col">
        <p style="width:300px; margin-bottom: 5px;">Mining the published literature for pathway figures and making their contents accessible for science.</p> 
        <a href="https://creativecommons.org/share-your-work/public-domain/cc0/" target="_blank"><img height="25px" src="/assets/img/cc0.jpg"/></a>
      </div>
 
      <div class="col"><ul class="social-media-list"><li><a href="https://github.com/wikipathways" target="_blank"><span style="color: #666;"><i class="fa fa-github fa"></i></span>&nbsp;&nbsp;<span style="color: #828282;">github</span></a></li><li><a href="https://www.twitter.com/wikipathways" target="_blank"><span style="color: #666;"><i class="fa fa-twitter fa"></i></span>&nbsp;&nbsp;<span style="color: #828282;">twitter</span></a></li><li><a href="https://fosstodon.org/web/@wikipathways" target="_blank"><span style="color: #000000;"><i class="fa fa-mastodon fa"></i></span>&nbsp;&nbsp;<span style="color: #000000;">mastodon</span></a></li><li><a href="https://github.com/wikipathways/wikipathways-help/discussions" target="_blank"><span style="color: #666;"><i class="fa fa-question-circle fa"></i></span>&nbsp;&nbsp;<span style="color: #828282;">forum</span></a></li></ul>
</div>
  
      <div class="col text-nowrap">
        <ul class="contact-list">
          <li><a href="/about.html">About</a></li>
          <li><a href="/help.html">Help</a></li>
          <li><a href="/help.html#analyze">Tools</a></li>
        </ul>
      </div>

      <div class="col text-nowrap">
        <ul class="contact-list">
          <li><a href="/stats.html">Statistics</a></li>
          <li><a href="/cite.html">How to cite</a></li>
          <li><a href="https://github.com/wikipathways/wikipathways-help/issues" target="_blank">Report a bug</a></li>
        </ul>
      </div>

    </div>
  </div>
</footer></body>
</html>
